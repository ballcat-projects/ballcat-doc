import{_ as p,r as c,o,c as l,a as n,b as s,d as t,e}from"./app-01a0a318.js";const i={},u=e(`<h1 id="数据权限" tabindex="-1"><a class="header-anchor" href="#数据权限" aria-hidden="true">#</a> 数据权限</h1><p>目前文档内容对标 ballcat v1.1.0 以上版本</p><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p>为了数据安全与企业组织分工，有时会需要划分每个用户可见的数据范围，例如：</p><ul><li><p>普通的销售人员只能看到自己的数据</p></li><li><p>地区的销售经理能看到当前地区的所有数据</p></li><li><p>销售总监可以看到所有的销售数据</p></li></ul><p>如果这些规则使用硬编码的方式进行处理，开发和维护成本极高。</p><p>而 Ballat 提供的数据权限组件<strong>只需进行少量的规则代码配置，即可实现数据权限控制</strong>。</p><h2 id="使用方式" tabindex="-1"><a class="header-anchor" href="#使用方式" aria-hidden="true">#</a> 使用方式</h2><h3 id="依赖引入" tabindex="-1"><a class="header-anchor" href="#依赖引入" aria-hidden="true">#</a> 依赖引入</h3><ul><li>组件已经推送到中央仓库，直接引入即可使用：</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.hccake<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ballcat-spring-boot-starter-datascope<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${lastedVersion}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数据规则定制" tabindex="-1"><a class="header-anchor" href="#数据规则定制" aria-hidden="true">#</a> 数据规则定制</h3><p>在使用数据权限之前，首先要定义自己项目的数据权限规则，在 Ballcat 中，数据权限规则对应的抽象表示为 <code>DataScope</code>。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DataScope</span> <span class="token punctuation">{</span>

	<span class="token doc-comment comment">/**
	 * 数据所对应的资源
	 * <span class="token keyword">@return</span> 资源标识
	 */</span>
	<span class="token class-name">String</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * 判断当前数据权限范围是否需要管理此表
	 * <span class="token keyword">@param</span> <span class="token parameter">tableName</span> 当前需要处理的表名
	 * <span class="token keyword">@return</span> 如果当前数据权限范围包含当前表名，则返回 true，否则返回 false
	 */</span>
	<span class="token keyword">boolean</span> <span class="token function">includes</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * 根据表名和表别名，动态生成的 where/or 筛选条件
	 * <span class="token keyword">@param</span> <span class="token parameter">tableName</span> 表名
	 * <span class="token keyword">@param</span> <span class="token parameter">tableAlias</span> 表别名，可能为空
	 * <span class="token keyword">@return</span> 数据规则表达式
	 */</span>
	<span class="token class-name">Expression</span> <span class="token function">getExpression</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">,</span> <span class="token class-name">Alias</span> tableAlias<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>getResource()</code></p><p>用于标识控制的数据资源，如按部门维护划分数据资源，则可以返回标识 “dept”，按班级维度划分，则可返回 “class”，这个标识会在部分需要进行数据权限忽略的场景使用</p></li><li><p><code>includes(tableName)</code></p><p>根据传入的表名，判断是否需要进行数据权限控制，判断逻辑用户可以完全自定义，例如通过前缀匹配、正则匹配、全等判断等。</p></li><li><p><code>getExpression(tableName, tableAlias)</code></p><p>返回数据权限的控制表达式，如用户 A 只能看到研发部的数据，则在 sql 中，应该追加 where 条件 <code>dept = &#39;研发部&#39;</code>。</p><p>方法返回类型 <code>Expression</code> 是 <strong>jsqlparser</strong> 工具对这个 Where 条件的 SQL 的抽象表示，返回 null 时则不拼接。</p></li></ul><p><strong>用户需要编写自己的 <code>DataScope</code></strong>，并注册到 Spring 容器中，<strong>可以同时注册多个 <code>DataScope</code> 实例</strong>，以实现多个维度的数据权限规则。</p><h2 id="使用示例" tabindex="-1"><a class="header-anchor" href="#使用示例" aria-hidden="true">#</a> 使用示例</h2><p><strong>无法打开 github 的小伙伴可以去 gitee 镜像库上查看代码示例。</strong></p>`,18),k={class:"custom-container tip"},d=n("p",{class:"custom-container-title"},"示例源码",-1),r={href:"https://github.com/ballcat-projects/ballcat",target:"_blank",rel:"noopener noreferrer"},m={class:"custom-container tip"},v=n("p",{class:"custom-container-title"},"更多示例",-1),b={href:"https://github.com/ballcat-projects/ballcat-samples",target:"_blank",rel:"noopener noreferrer"},g=e(`<h3 id="示例背景" tabindex="-1"><a class="header-anchor" href="#示例背景" aria-hidden="true">#</a> 示例背景</h3><h4 id="数据结构" tabindex="-1"><a class="header-anchor" href="#数据结构" aria-hidden="true">#</a> 数据结构</h4><p>假设系统中只有一张学生表需要做数据权限控制，学生表的数据如下：</p><table><thead><tr><th>id</th><th>name</th><th>class_name</th></tr></thead><tbody><tr><td>1</td><td>张三</td><td>一班</td></tr><tr><td>2</td><td>李四</td><td>一班</td></tr><tr><td>3</td><td>王五</td><td>二班</td></tr><tr><td>4</td><td>老六</td><td>三班</td></tr></tbody></table><h4 id="数据权限规则" tabindex="-1"><a class="header-anchor" href="#数据权限规则" aria-hidden="true">#</a> 数据权限规则</h4><p>在本示例中，有如下两个维度的数据权限规则：</p><ol><li>针对于班级维度的数据资源：老师可以看到他所带的班级的所有数据，根据班级 class_name 划分</li><li>针对于学生维度的数据资源：学生只能看到他自己的数据，根据 id 划分</li></ol><p>比如：</p><ul><li><p>对于只教授一班的老师 B，他登录系统后可以看到张三和李四的数据信息</p></li><li><p>对于同时教授二班和三班的老师 A，他登录系统后可以看到王五和老六的数据信息</p></li><li><p>对于学生王五，登录后只能看到王五本人的数据信息</p></li></ul><h4 id="登录用户" tabindex="-1"><a class="header-anchor" href="#登录用户" aria-hidden="true">#</a> 登录用户</h4><p>对于登录用户的数据信息抽象为一个 <code>LoginUser</code> 对象，在用户登录后将 <code>LoginUser</code> 的信息存储到 <code>LoginUserHolder</code> 中</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginUser</span> <span class="token punctuation">{</span>

	<span class="token doc-comment comment">/**
	 * 登录用户 id
	 */</span>
	<span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * 用户角色: 老师或者学生
	 */</span>
	<span class="token keyword">private</span> <span class="token class-name">UserRoleType</span> userRoleType<span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * 当前登录用户所拥有的班级，只有老师才有此属性
	 */</span>
	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> classNameList<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="datascope-编写" tabindex="-1"><a class="header-anchor" href="#datascope-编写" aria-hidden="true">#</a> DataScope 编写</h3><p>针对两种数据维度的权限规则，<strong>我们只需要对应编写两个 <code>DataScope</code></strong>，并注册到 spring 容器中，即完成了数据权限的控制处理。</p><h4 id="班级维度" tabindex="-1"><a class="header-anchor" href="#班级维度" aria-hidden="true">#</a> 班级维度</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassDataScope</span> <span class="token keyword">implements</span> <span class="token class-name">DataScope</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tableNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token constant">CASE_INSENSITIVE_ORDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">ClassDataScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		tableNames<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;h2student&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;h2teacher&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">includes</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 使用 new TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER) 的形式判断，可忽略表名大小写</span>
		<span class="token keyword">return</span> tableNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Expression</span> <span class="token function">getExpression</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">,</span> <span class="token class-name">Alias</span> tableAlias<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 假设登录用户信息可以从内存中获取</span>
		<span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">LoginUserHolder</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 如果当前登录用户为空，或者是老师，但是没有任何班级权限</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">UserRoleType</span><span class="token punctuation">.</span><span class="token constant">TEACHER</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUserRoleType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token operator">&amp;&amp;</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getClassNameList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// where 1 = 2 永不满足</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EqualsTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LongValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LongValue</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 如果是学生，则不控制，因为学生的权限会在 StudentDataScope 中处理</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserRoleType</span><span class="token punctuation">.</span><span class="token constant">STUDENT</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUserRoleType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		
		<span class="token comment">// 提取当前登录用户拥有的班级权限</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Expression</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getClassNameList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">StringValue</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExpressionList</span> expressionList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpressionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		expressionList<span class="token punctuation">.</span><span class="token function">setExpressions</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 列名</span>
        <span class="token class-name">Column</span> column <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>tableAlias <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;class_name&quot;</span> <span class="token operator">:</span> tableAlias<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;class_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 条件：class_name in (xxx, xxx)</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InExpression</span><span class="token punctuation">(</span>column<span class="token punctuation">,</span> expressionList<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="学生维度" tabindex="-1"><a class="header-anchor" href="#学生维度" aria-hidden="true">#</a> 学生维度</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentDataScope</span> <span class="token keyword">implements</span> <span class="token class-name">DataScope</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RESOURCE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;student&quot;</span><span class="token punctuation">;</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> <span class="token constant">TABLE_NAME_PATTEN</span> <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&quot;^h2student*$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">RESOURCE_NAME</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">includes</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 可以利用正则做匹配</span>
		<span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> <span class="token constant">TABLE_NAME_PATTEN</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> matcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Expression</span> <span class="token function">getExpression</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">,</span> <span class="token class-name">Alias</span> tableAlias<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">LoginUserHolder</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 如果当前登录用户为空</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// where 1 = 2 永不满足</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EqualsTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LongValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LongValue</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 如果是老师则直接放行</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserRoleType</span><span class="token punctuation">.</span><span class="token constant">TEACHER</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUserRoleType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 学生只能查到他自己的数据 where id = xx</span>
		<span class="token class-name">Column</span> column <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>tableAlias <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">:</span> tableAlias<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EqualsTo</span><span class="token punctuation">(</span>column<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LongValue</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="权限测试" tabindex="-1"><a class="header-anchor" href="#权限测试" aria-hidden="true">#</a> 权限测试</h3><p>我们在 <code>StudentService</code> 中提供一个 <code>listStudent()</code> 方法，对应的查询 SQL 为 <code>select * from h2student</code>。</p><p>在不同用户登录后调用同一个方法，会根据他们的角色以及拥有的班级返回不同的数据。</p><h4 id="老师用户查询" tabindex="-1"><a class="header-anchor" href="#老师用户查询" aria-hidden="true">#</a> 老师用户查询</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">testStudentSelect1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户登录</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setUserRoleType</span><span class="token punctuation">(</span><span class="token class-name">UserRoleType</span><span class="token punctuation">.</span><span class="token constant">TEACHER</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 教师</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setClassNameList</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">&quot;一班&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LoginUserHolder</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 一班有两个学生：张三和李四</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList1 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> studentList1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span> studentList1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span> studentList1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 切换登录用户所管理的班级</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setClassNameList</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">&quot;二班&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 二班只有一个学生：王五</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList2 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> studentList2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">,</span> studentList2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="学生用户查询" tabindex="-1"><a class="header-anchor" href="#学生用户查询" aria-hidden="true">#</a> 学生用户查询</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">testStudentSelect2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户登录</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setUserRoleType</span><span class="token punctuation">(</span><span class="token class-name">UserRoleType</span><span class="token punctuation">.</span><span class="token constant">STUDENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 学生</span>
    <span class="token class-name">LoginUserHolder</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// id 为 1 的学生叫 张三</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList1 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> studentList1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span> studentList1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 切换登录用户</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// id 为 2 的学生叫 李四</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList2 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> studentList2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span> studentList2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="局部规则修改" tabindex="-1"><a class="header-anchor" href="#局部规则修改" aria-hidden="true">#</a> 局部规则修改</h2><p><strong>默认注册的 <code>DataScope</code> 会对全局的所有 SQL 进行拦截处理。</strong></p><blockquote><p>对于不涉及到权限的表的 SQL，在第一次执行后将会被记录下来，后续直接跳过 SQL 处理，提升性能</p></blockquote><p>而在这些使用场景下，我们需要进行局部的数据权限规则修改，例如：</p><ul><li>某些方法需要忽略数据权限控制</li><li>配置了多个 <code>DataScope</code>，只想其中的某个规则生效</li><li>配置了多个 <code>DataScope</code>，需要忽略其中的某个规则</li></ul><h3 id="声明式规则修改" tabindex="-1"><a class="header-anchor" href="#声明式规则修改" aria-hidden="true">#</a> 声明式规则修改</h3><p><code>@DataPermission</code> 注解可标记在类或者方法上，用于动态控制数据权限</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DataPermission</span> <span class="token punctuation">{</span>

	<span class="token doc-comment comment">/**
	 * 当前类或方法是否忽略数据权限
	 * <span class="token keyword">@return</span> boolean 默认返回 false
	 */</span>
	<span class="token keyword">boolean</span> <span class="token function">ignore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * 仅对指定资源类型进行数据权限控制，只在开启情况下有效，当该数组有值时，exclude不生效
	 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">DataPermission</span><span class="token punctuation">#</span><span class="token field">excludeResources</span></span>
	 * <span class="token keyword">@return</span> 资源类型数组
	 */</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">includeResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * 对指定资源类型跳过数据权限控制，只在开启情况下有效，当该includeResources有值时，exclude不生效
	 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">DataPermission</span><span class="token punctuation">#</span><span class="token field">includeResources</span></span>
	 * <span class="token keyword">@return</span> 资源类型数组
	 */</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">excludeResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="基本使用" tabindex="-1"><a class="header-anchor" href="#基本使用" aria-hidden="true">#</a> <strong>基本使用</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 该方法忽略数据权限控制</span>
<span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>ignore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">listIgnoreDataPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 该方法执行时只会根据资源标识为 gender 和 class 的 DataScope 进行数据权限处理</span>
<span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>includeResources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">list1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// 该方法执行时排除资源标识为 class 的 DataScope，不对其进行数据权限处理，其他 DataScope 不受影响</span>
<span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>excludeResources <span class="token operator">=</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">list2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="注解的查找规则" tabindex="-1"><a class="header-anchor" href="#注解的查找规则" aria-hidden="true">#</a> <strong>注解的查找规则</strong></h4><p>方法执行时，会按以下顺序依次查找可用的 <code>@DataPermission</code> 注解：</p><p>​ <strong>当前方法上的注解</strong> =&gt; <strong>超类方法上的注解</strong> =&gt; <strong>当前类上注解</strong> =&gt; <strong>超类上的注解</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>includeResources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 该方法只对 class 资源进行控制</span>
        <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 该方法只对 gender 资源进行控制</span>
        <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 该方法忽略所有的数据权限控制</span>
        <span class="token function">method4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 该方法只对 gender 和 class 进行数据权限控制</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>includeResources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>includeResources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>ignore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token function">method4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="局部规则的传递" tabindex="-1"><a class="header-anchor" href="#局部规则的传递" aria-hidden="true">#</a> 局部规则的传递</h4><p>当执行方法上根据注解的查找规则，没有查询到注解时，则会使用调用者的数据权限规则：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>includeResources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">B</span><span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 该方法上有自己的 @DataPermission 注解，只会对 class 资源进行控制</span>
        <span class="token class-name">B</span><span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 该方法则跟随 test() 方法的数据权限注解，只对 gender 资源进行控制</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">B</span><span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 依然只会对 class 资源进行控制</span>
        <span class="token class-name">B</span><span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 跟随全局的数据权限规则</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>includeResources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="编程式规则修改" tabindex="-1"><a class="header-anchor" href="#编程式规则修改" aria-hidden="true">#</a> 编程式规则修改</h3><p>从版本 <strong>v0.7.0</strong> 开始，<code>DataPermissionHandler</code> 提供了编程式的局部数据权限修改功能。</p><h4 id="基本使用-1" tabindex="-1"><a class="header-anchor" href="#基本使用-1" aria-hidden="true">#</a> 基本使用</h4><p>和 <code>@DataPermission</code> 注解的属性对应，我们需要构建一个 <code>DataPermissionRule</code> 对象来标识当前的数据权限规则：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 数据权限规则：忽略全部数据权限</span>
<span class="token class-name">DataPermissionRule</span> dataPermissionRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataPermissionRule</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或者</span>
<span class="token class-name">DataPermissionRule</span> dataPermissionRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataPermissionRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIgnore</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 数据权限规则：只根据班级维度查询</span>
<span class="token class-name">DataPermissionRule</span> dataPermissionRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataPermissionRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setIncludeResources</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;class&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 数据权限规则：不根据班级维度查询</span>
<span class="token class-name">DataPermissionRule</span> dataPermissionRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataPermissionRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setExcludeResources</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;class&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在指定的规则下进行操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 在指定数据权限规则下进行查询</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">DataPermissionUtils</span><span class="token punctuation">.</span><span class="token function">executeWithDataPermissionRule</span><span class="token punctuation">(</span>dataPermissionRule<span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> studentList <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="嵌套使用" tabindex="-1"><a class="header-anchor" href="#嵌套使用" aria-hidden="true">#</a> 嵌套使用</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 编程式数据权限，</span>
<span class="token class-name">DataPermissionRule</span> dataPermissionRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataPermissionRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setIncludeResources</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;class&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataPermissionUtils</span><span class="token punctuation">.</span><span class="token function">executeWithDataPermissionRule</span><span class="token punctuation">(</span>dataPermissionRule<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 编程式数据权限内部方法，根据 class 维度进行数据权限控制</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 嵌套的权限控制: 内部忽略数据权限控制</span>
    <span class="token class-name">DataPermissionRule</span> innerIgnoreRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataPermissionRule</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DataPermissionUtils</span><span class="token punctuation">.</span><span class="token function">executeWithDataPermissionRule</span><span class="token punctuation">(</span>innerRule<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 规则嵌套时，优先使用内部规则, 会忽略数据权限查询出全部学生</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> allStudent <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="声明式和编程式的混合使用" tabindex="-1"><a class="header-anchor" href="#声明式和编程式的混合使用" aria-hidden="true">#</a> 声明式和编程式的混合使用</h3><p>混合使用时，权限规则按照由近及远的顺序查找：</p><p><strong>方法内部的编程式规则</strong> &gt; <strong>当前方法查找出来的注解规则</strong> &gt; <strong>调用者的权限规则</strong> &gt; <strong>全局规则</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentService</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> <span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// 忽略权限控制</span>
	<span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>ignore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> <span class="token function">listStudentWithoutDataPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@DataPermission</span><span class="token punctuation">(</span>includeResources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">testStudentSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 根据方法上的 @DataPermission 注解，只根据 gender 维度进行数据权限控制</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList1 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 编程式数据权限规则</span>
    <span class="token class-name">DataPermissionRule</span> dataPermissionRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataPermissionRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setIncludeResources</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;class&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DataPermissionUtils</span><span class="token punctuation">.</span><span class="token function">executeWithDataPermissionRule</span><span class="token punctuation">(</span>dataPermissionRule<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 编程式数据权限内部方法，根据 class 维度进行数据权限控制</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> studentList2 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 由于 listStudentWithoutDataPermission 添加了 @DataPermission 注解</span>
        <span class="token comment">// 会忽略权限控制，查询出所有的学生</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> allStudent <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">listStudentWithoutDataPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,58);function h(f,w){const a=c("ExternalLinkIcon");return o(),l("div",null,[u,n("div",k,[d,n("p",null,[s("本节的示例代码，可以在 "),n("a",r,[s("ballcat-spring-boot-starter-datascope"),t(a)]),s(" 模块的单元测试用例中查看。")])]),n("div",m,[v,n("p",null,[s("在 "),n("a",b,[s("ballcat-sample-admin"),t(a)]),s(" 模块下有一个基于部门的完整数据权限使用示例")])]),g])}const S=p(i,[["render",h],["__file","data-scope.html.vue"]]);export{S as default};
